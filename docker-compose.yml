services:
  postgres:
    image: postgres:16-alpine
    container_name: tm-postgres
    restart: unless-stopped
    environment:
      - "PGDATA=/var/lib/postgresql/data/pg_data"
      - "POSTGRES_DB=uniset"
      - "POSTGRES_USER=admin"
      - "POSTGRES_PASSWORD=123"
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/postgres-init.sql:/docker-entrypoint-initdb.d/10-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d uniset"]
      interval: 5s
      timeout: 3s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.8-alpine
    container_name: tm-clickhouse
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "8123:8123"
    volumes:
      - chdata:/var/lib/clickhouse
      - ./scripts/clickhouse-init.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./scripts/clickhouse-data.sql:/docker-entrypoint-initdb.d/02-data.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query='SELECT 1'"]
      interval: 5s
      timeout: 3s
      retries: 5

  playwright:
    image: mcr.microsoft.com/playwright:v1.39.0-jammy
    container_name: tm-playwright
    profiles: ["tests"]
    working_dir: /workspace
    shm_size: 1g
    volumes:
      - ./:/workspace
      - playwright-browsers:/ms-playwright
      - playwright-node:/workspace/node_modules
    depends_on:
      timemachine:
        condition: service_healthy
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    environment:
      - BASE_URL=http://timemachine:9090
      - NPM_CONFIG_CACHE=/tmp/.npm
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - PLAYWRIGHT_JUNIT_OUTPUT_NAME=/tmp/playwright-junit.xml
      - NODE_PATH=/workspace/node_modules
    entrypoint:
      - bash
      - -lc
      - |
        npm install --no-fund --no-audit @playwright/test@1.39.0
        npx playwright install chromium
        npx playwright test -c tests/playwright.config.ts --output /tmp/playwright-results --reporter=list

  timemachine:
    build: .
    container_name: tm-app
    restart: unless-stopped
    command: >
      --http-addr 0.0.0.0:9090
      --confile config/test.xml
      --slist ALL
      --output stdout
      --save-output=false
      --window 15s
      --step 1s
    ports:
      - "9090:9090"
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    profiles: ["tests"]

volumes:
  pgdata: {}
  chdata: {}
  playwright-browsers: {}
  playwright-node:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/.node_modules
